---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<div class="container" id="app-root">
		<!-- Sidebar -->
		<aside id="sidebar" class="surface" aria-label="Notes list">
			<header class="header" style="border-top-left-radius: var(--radius-md); border-top-right-radius: var(--radius-md);">
				<div class="app-title" aria-live="polite">
					Notes
					<span id="notes-count" class="badge" aria-hidden="true">0</span>
				</div>
				<div style="display:flex; gap:8px;">
					<button id="create-note" class="btn btn-primary" aria-label="Create a new note">
						<span aria-hidden="true">＋</span> New
					</button>
				</div>
			</header>
			<div style="padding: 8px 8px 12px;">
				<label for="search-notes" class="sr-only">Search notes</label>
				<input id="search-notes" class="input" type="search" placeholder="Search notes..." autocomplete="off" />
			</div>
			<nav id="notes-list" role="listbox" aria-label="Notes" style="padding: 8px; display: grid; gap: 8px; overflow: auto; max-height: calc(100vh - 148px);">
				<!-- Filled by client script -->
			</nav>
		</aside>

		<!-- Main Editor -->
		<main id="editor-pane" class="surface" aria-live="polite" aria-busy="false">
			<header class="header" style="border-top-left-radius: var(--radius-md); border-top-right-radius: var(--radius-md);">
				<div style="display:flex; align-items:center; gap: 12px;">
					<div id="status-dot" title="Status" style="width:10px;height:10px;border-radius:50%;background:var(--color-primary); box-shadow:0 0 0 3px rgba(37,99,235,.15)"></div>
					<div id="active-note-title" class="app-title">No note selected</div>
				</div>
				<div style="display:flex; gap:8px;">
					<button id="delete-note" class="btn btn-danger" aria-label="Delete note" disabled>Delete</button>
					<button id="save-note" class="btn btn-primary" aria-label="Save note" disabled>Save</button>
				</div>
			</header>

			<section id="empty-state" style="padding: 24px;">
				<p style="margin:0;color:var(--text-secondary)">Select a note from the left or create a new one.</p>
			</section>

			<section id="editor" style="display:none; padding: 16px; display:grid; gap:12px;">
				<label for="title" style="font-weight:600;">Title</label>
				<input id="title" class="input" type="text" placeholder="Note title" aria-required="true" />
				<label for="content" style="font-weight:600;">Content</label>
				<textarea id="content" class="textarea" placeholder="Write your note here..." aria-required="false"></textarea>
				<div style="display:flex;justify-content:space-between;align-items:center;color:var(--text-secondary);">
					<small id="meta" aria-live="polite"></small>
					<small>Autosave is off</small>
				</div>
			</section>

			<section id="loading" style="padding: 24px; display:none;">
				<p style="margin:0;">Loading…</p>
			</section>

			<section id="error" style="padding: 24px; display:none;">
				<p style="margin:0;color:var(--color-error)">Something went wrong while loading notes. Please try again.</p>
			</section>
		</main>
	</div>

	<style>
		#sidebar {
			margin: 12px;
			padding: 0;
			min-height: calc(100vh - 24px);
		}
		@media (max-width: 900px) {
			#sidebar {
				min-height: auto;
				margin: 12px 12px 0 12px;
			}
		}
		#editor-pane {
			margin: 12px 12px 12px 0;
			padding: 0;
			min-height: calc(100vh - 24px);
			display: flex;
			flex-direction: column;
		}
		@media (max-width: 900px) {
			#editor-pane {
				margin: 12px;
				min-height: auto;
			}
		}
		.note-item {
			border: 1px solid var(--border-color);
			background: var(--surface-color);
			border-radius: 10px;
			padding: 10px 12px;
			cursor: pointer;
			transition: border-color .2s ease, box-shadow .2s ease, transform .06s ease;
			text-align: left;
		}
		.note-item:hover {
			box-shadow: 0 6px 12px var(--shadow-hover-color);
			transform: translateY(-1px);
		}
		.note-item[aria-selected="true"] {
			border-color: var(--color-primary);
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
		}
		.note-title {
			font-weight: 600;
			margin: 0 0 4px 0;
		}
		.note-snippet {
			margin: 0;
			color: var(--text-secondary);
			font-size: 0.875rem;
			overflow: hidden;
			text-overflow: ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
		}
		.sr-only {
			position: absolute;
			width: 1px;
			height: 1px;
			padding: 0;
			margin: -1px;
			overflow: hidden;
			clip: rect(0, 0, 0, 0);
			border: 0;
		}
	</style>

	<script is:inline>
		// PUBLIC_INTERFACE
		/**
		 * DataService abstracts CRUD for notes. It prefers REST if PUBLIC_API_BASE is set,
		 * otherwise uses localStorage for persistence during the session.
		 */
		class DataService {
			constructor() {
				let api = undefined;
				try {
					if (typeof import !== 'undefined' && typeof import.meta !== 'undefined' && import.meta.env) {
						api = import.meta.env.PUBLIC_API_BASE;
					}
				} catch (e) { /* ignore */ }
				this.apiBase = api;
				this.usingApi = !!this.apiBase;
				this.storageKey = 'notes-app-items';
			}
			// PUBLIC_INTERFACE
			async list() {
				if (this.usingApi) {
					try {
						const res = await fetch(this.apiBase + '/notes', { credentials: 'include' });
						if (!res.ok) throw new Error('Failed listing');
						return await res.json();
					} catch (e) {
						console.warn('API unavailable, falling back to local storage.', e);
						this.usingApi = false;
						return this._lsList();
					}
				}
				return this._lsList();
			}
			// PUBLIC_INTERFACE
			async create(note) {
				if (this.usingApi) {
					const res = await fetch(this.apiBase + '/notes', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(note),
						credentials: 'include'
					});
					if (!res.ok) throw new Error('Create failed');
					return await res.json();
				}
				return this._lsCreate(note);
			}
			// PUBLIC_INTERFACE
			async update(id, note) {
				if (this.usingApi) {
					const res = await fetch(this.apiBase + '/notes/' + encodeURIComponent(id), {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(note),
						credentials: 'include'
					});
					if (!res.ok) throw new Error('Update failed');
					return await res.json();
				}
				return this._lsUpdate(id, note);
			}
			// PUBLIC_INTERFACE
			async remove(id) {
				if (this.usingApi) {
					const res = await fetch(this.apiBase + '/notes/' + encodeURIComponent(id), {
						method: 'DELETE',
						credentials: 'include'
					});
					if (!res.ok) throw new Error('Delete failed');
					return true;
				}
				return this._lsRemove(id);
			}
			// LOCAL STORAGE BACKING
			_lsReadAll() {
				const raw = localStorage.getItem(this.storageKey);
				if (!raw) return [];
				try { return JSON.parse(raw) || []; } catch { return []; }
			}
			_lsWriteAll(list) {
				localStorage.setItem(this.storageKey, JSON.stringify(list));
			}
			_lsList() {
				return Promise.resolve(this._lsReadAll());
			}
			_lsCreate(note) {
				const list = this._lsReadAll();
				const now = new Date().toISOString();
				const item = { id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random())), title: note.title || 'Untitled', content: note.content || '', createdAt: now, updatedAt: now };
				list.unshift(item);
				this._lsWriteAll(list);
				return Promise.resolve(item);
			}
			_lsUpdate(id, note) {
				const list = this._lsReadAll();
				const idx = list.findIndex(n => n.id === id);
				if (idx === -1) return Promise.reject(new Error('Not found'));
				const now = new Date().toISOString();
				list[idx] = Object.assign({}, list[idx], note, { updatedAt: now });
				this._lsWriteAll(list);
				return Promise.resolve(list[idx]);
			}
			_lsRemove(id) {
				const list = this._lsReadAll().filter(n => n.id !== id);
				this._lsWriteAll(list);
				return Promise.resolve(true);
			}
		}

		// UI Controller
		const state = {
			list: [],
			activeId: null,
			loading: false,
			error: null,
			filter: '',
			dirty: false,
		};

		let service;

		function qs(id) { return document.getElementById(id); }

		function setLoading(isLoading) {
			state.loading = isLoading;
			qs('editor').style.display = isLoading ? 'none' : (state.activeId ? 'grid' : 'none');
			qs('empty-state').style.display = (!isLoading && !state.activeId) ? 'block' : 'none';
			qs('loading').style.display = isLoading ? 'block' : 'none';
		}

		function setError(err) {
			state.error = err;
			qs('error').style.display = err ? 'block' : 'none';
		}

		function formatDate(iso) {
			try {
				const d = new Date(iso);
				return d.toLocaleString();
			} catch (_e) { return ''; }
		}

		function renderList() {
			const listEl = qs('notes-list');
			listEl.innerHTML = '';
			const q = (state.filter || '').toLowerCase();

			const items = state.list.filter(function(n) {
				if (!q) return true;
				return (n.title || '').toLowerCase().includes(q) || (n.content || '').toLowerCase().includes(q);
			});

			items.forEach(function(n) {
				const btn = document.createElement('button');
				btn.className = 'note-item';
				btn.setAttribute('role', 'option');
				btn.setAttribute('aria-selected', n.id === state.activeId ? 'true' : 'false');
				btn.dataset.id = n.id;

				const title = document.createElement('p');
				title.className = 'note-title';
				title.textContent = n.title || 'Untitled';

				const snippet = document.createElement('p');
				snippet.className = 'note-snippet';
				snippet.textContent = (n.content || '').trim().slice(0, 160) || 'No content';

				btn.appendChild(title);
				btn.appendChild(snippet);

				btn.addEventListener('click', function() { openNote(n.id); });
				btn.addEventListener('keydown', function(e) {
					if (e.key === 'Enter' || e.key === ' ') {
						e.preventDefault();
						openNote(n.id);
					}
				});
				listEl.appendChild(btn);
			});

			qs('notes-count').textContent = String(items.length);
		}

		function updateEditorMeta(n) {
			qs('meta').textContent = n ? ('Updated: ' + formatDate(n.updatedAt)) : '';
			qs('active-note-title').textContent = n ? (n.title || 'Untitled') : 'No note selected';
		}

		function openNote(id) {
			state.activeId = id;
			const n = state.list.find(function(i){ return i.id === id; });
			qs('title').value = (n && n.title) || '';
			qs('content').value = (n && n.content) || '';
			updateEditorMeta(n || null);
			qs('editor').style.display = 'grid';
			qs('empty-state').style.display = 'none';
			qs('save-note').disabled = false;
			qs('delete-note').disabled = false;
			renderList();
		}

		async function init() {
			service = new DataService();

			// wire events
			qs('create-note').addEventListener('click', async function() {
				const created = await service.create({ title: 'Untitled', content: '' });
				state.list.unshift(created);
				renderList();
				openNote(created.id);
			});

			qs('search-notes').addEventListener('input', function(e) {
				state.filter = e.target.value;
				renderList();
			});

			qs('save-note').addEventListener('click', async function() {
				if (!state.activeId) return;
				const title = (qs('title').value || '').trim() || 'Untitled';
				const content = qs('content').value || '';
				const updated = await service.update(state.activeId, { title: title, content: content });
				const idx = state.list.findIndex(function(n){ return n.id === state.activeId; });
				if (idx !== -1) state.list[idx] = updated;
				updateEditorMeta(updated);
				renderList();
			});

			qs('delete-note').addEventListener('click', async function() {
				if (!state.activeId) return;
				const id = state.activeId;
				await service.remove(id);
				state.list = state.list.filter(function(n){ return n.id !== id; });
				state.activeId = null;
				qs('editor').style.display = 'none';
				qs('empty-state').style.display = 'block';
				qs('save-note').disabled = true;
				qs('delete-note').disabled = true;
				renderList();
			});

			qs('title').addEventListener('input', function() {
				state.dirty = true;
			});
			qs('content').addEventListener('input', function() {
				state.dirty = true;
			});

			// Initial load
			try {
				setLoading(true);
				const items = await service.list();
				state.list = items;
				renderList();
				if (state.list.length) {
					openNote(state.list[0].id);
				} else {
					qs('empty-state').style.display = 'block';
				}
			} catch (e) {
				console.error(e);
				setError(e);
			} finally {
				setLoading(false);
			}
		}

		// Bootstrap
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', init);
		} else {
			init();
		}
	</script>
</Layout>
